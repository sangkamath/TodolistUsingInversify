import deatultOptions from "./config/default_settings";
import consoleRenderer from "./renderers/console_renderer";
import requestReducer from "./reducers/request_reducer";
import textSerializer from "./serializers/text/text_serializer";
import { guid } from "./utils/utils";
import { getTime, getTimeDiference } from "./utils/utils";
function makeLoggerMiddleware(settings, renderer) {
    var logger = function (next) {
        if (settings === undefined || settings === null) {
            settings = deatultOptions;
        }
        if (renderer === undefined || renderer === null) {
            renderer = consoleRenderer;
        }
        return function (args) {
            var results = null;
            var logEntry = {
                error: false,
                exception: null,
                guid: guid(),
                multiInject: args.isMultiInject,
                results: [],
                rootRequest: null,
                serviceIdentifier: args.serviceIdentifier,
                time: null
            };
            var nextContextInterceptor = args.contextInterceptor;
            args.contextInterceptor = function (context) {
                logEntry.rootRequest = requestReducer(context.plan.rootRequest, settings.request);
                return nextContextInterceptor(context);
            };
            try {
                var start = getTime();
                results = next(args);
                var end = getTime();
                logEntry.results = results;
                logEntry.time = (settings.time) ? getTimeDiference(start, end) : null;
            }
            catch (e) {
                logEntry.error = true;
                logEntry.exception = e;
                logEntry.time = null;
            }
            renderer(logEntry);
            if (results) {
                return results;
            }
            else {
                throw new Error(logEntry.exception.message);
            }
        };
    };
    return logger;
}
export { makeLoggerMiddleware, textSerializer };
